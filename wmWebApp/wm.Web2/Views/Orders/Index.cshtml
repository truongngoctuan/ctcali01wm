@model wm.Model.GoodCategory

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Index</h2>


<div class="row">
    <h4>Update good categories</h4>
    <hr />
    <div class="col-md-4">
        @foreach (var item in ViewBag.GoodCategories)
        {
            <div class="col-md-12 GoodCategoryItem"><a href="@item.Id"> @item.Name</a></div>
        }
    </div>
    <div class="col-md-8">
        <div class="form-group row col-md-12">
            <div id="hsIncludeExclude" class=""></div>
        </div>
        <div class="form-group">
            <div class="col-md-12">
                <button name="save" id="save" class="btn btn-danger" onclick="saveIncludeExclude()">Save</button>
            </div>
        </div>
    </div>


</div>

<div>
    @Html.ActionLink("Back to List", "Index")
</div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script>
        //================================================================================
        //helper
        function ajaxPOSTRequest(href, dataObject, onSuccessCallback) {
            $.ajax({
                url: href,
                data: dataObject,
                cache: false,
                type: "POST",
                dataType: "html",
                success: onSuccessCallback
            });
        }
        //================================================================================
        var $$ = function (id) {
            return document.getElementById(id);
        },
    container = $$('hsIncludeExclude'),
    autosave = $$('autosave'),
    load = $$('load'),
    save = $$('save'),
    autosaveNotification,
    hot,
    dataInput;

        $(document).ready(function () {
            //$(".GoodCategoryItem").each(function (data) {
            //    var aId = data.attr("href");

            //});

            loadIncludeExclude();
        });

        hot = new Handsontable(container, {
            startRows: 1,
            startCols: 2,
            rowHeaders: true,
            colHeaders: false,
            dataSchema: { Id: null, Name: null, RecommendedQuantity: null, Quantity: null },
            columns: [//TODO: change colorbackground for readonly
              //{ data: 'CategoryId', readOnly: true },
              { data: 'Name', readOnly: true },
              { data: 'InStock', readOnly: false },
              { data: 'RecommenedQuantity', readOnly: true },
              { data: 'Quantity', readOnly: false },
              { data: 'Note', readOnly: true },
                { data: 'YourNote', readOnly: false },

              //{ data: 'IsChecked', type: 'checkbox' },
            ],
            afterChange: function (change, source) {
                if (source === 'loadData') {
                    return; //don't save this change
                }
                console.log("change: " + JSON.stringify(hot.getSourceDataAtRow(change[0][0])));

            }
        });

        @*function loadIncludeExclude() {
            ajaxPOSTRequest('@Url.Action("PopulateData")', {id : @Model.Id, isInEx: true},
                function (data, textStatus, XMLHttpRequest) {
                    console.log("client received: " + data);

                    dataInput = JSON.parse(data);
                    hot.loadData(dataInput);

                });
        }*@

        @*function saveIncludeExclude() {
            console.log("local data: " + JSON.stringify({ data: dataInput }));

            //only send checked items to server
            var dataOutputFiltered = [];
            for (i = 0; i < dataInput.length; i++) {
                if (dataInput[i].IsChecked == true) {
                    dataOutputFiltered.push(dataInput[i]);
                }
            }

            ajaxPOSTRequest('@Url.Action("placingOrder")',
                { id: @Model.Id, data: dataOutputFiltered },
                function (data, textStatus, XMLHttpRequest) {
                    var dataObject = JSON.parse(data);
                    if (dataObject.status = "ok") {
                        //window.location.href = '@Url.Action("Edit", new { id = Model.Id})';
                    }
                    else {
                        console.log("error IncludeExcludeNNData");
                    }
                });
        }*@

    </script>
}
